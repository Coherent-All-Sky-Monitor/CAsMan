<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SNAP Ports</title>
  <style>
    @font-face {
      font-family: 'National Park';
      src: url('/visualize/static/fonts/NationalPark-Regular.woff') format('woff');
      font-weight: normal;
      font-style: normal;
    }
    @font-face {
      font-family: 'National Park Bold';
      src: url('/visualize/static/fonts/NationalPark-Bold.woff') format('woff');
      font-weight: bold;
      font-style: normal;
    }
    @font-face {
      font-family: 'National Park ExtraBold';
      src: url('/visualize/static/fonts/NationalPark-ExtraBold.woff') format('woff');
      font-weight: 900;
      font-style: normal;
    }

    body.light-mode {
      font-family: 'National Park', sans-serif;
      margin: 0;
      background-color: #f0f0f5;
      color: #333;
    }

    body.dark-mode {
      font-family: 'National Park', sans-serif;
      margin: 0;
      background-color: #333;
      color: #f0f0f5;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 20px 8px 0 8px;
    }

    /* When filtering to single chassis/slot, use narrower max-width */
    .container.filtered {
      max-width: 900px;
    }

    /* Fixed Toolbar */
    .fixed-toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 2px solid currentColor;
      backdrop-filter: blur(10px);
    }

    body.light-mode .fixed-toolbar {
      background: rgba(240, 240, 245, 0.95);
    }

    body.dark-mode .fixed-toolbar {
      background: rgba(51, 51, 51, 0.95);
    }

    .toolbar-spacer {
      height: 70px;
    }

    .home-button {
      padding: 10px 15px;
      cursor: pointer;
      border: 2px solid currentColor;
      background: transparent;
      text-decoration: none;
      color: inherit;
      font-size: 14px;
      font-family: 'National Park', sans-serif;
      transition: all 0.2s;
      border-radius: 8px;
    }

    .home-button:hover {
      background: #333;
      color: #f0f0f5;
    }

    body.dark-mode .home-button:hover {
      background: #f0f0f5;
      color: #333;
    }

    .dark-mode-toggle {
      cursor: pointer;
      font-size: 24px;
      padding: 10px;
    }

    .sun {
      display: none;
    }

    .moon {
      display: inline;
    }

    body.dark-mode .sun {
      display: inline;
    }

    body.dark-mode .moon {
      display: none;
    }

    .dark-mode-toggle span {
      transition: transform 0.3s ease;
    }

    .dark-mode-toggle:hover span {
      transform: rotate(45deg);
    }

    h1 {
      font-family: 'National Park ExtraBold', sans-serif;
      text-align: center;
      margin: 20px 0;
      font-size: 2.5em;
      color: inherit;
      font-weight: 900;
    }

    .filter-controls {
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid currentColor;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    body.dark-mode .filter-controls {
      background: rgba(34, 34, 34, 0.95);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .filter-controls form {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .filter-controls label {
      font-family: 'National Park Bold', sans-serif;
      font-weight: bold;
    }

    .filter-controls select {
      padding: 8px 12px;
      border: 2px solid currentColor;
      border-radius: 4px;
      background: transparent;
      color: inherit;
      font-family: 'National Park', sans-serif;
      font-size: 14px;
      cursor: pointer;
    }

    .filter-controls select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    body.dark-mode .filter-controls select:focus {
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
    }

    .clear-filter {
      padding: 8px 15px;
      cursor: pointer;
      border: 2px solid currentColor;
      background: transparent;
      color: inherit;
      font-size: 14px;
      font-family: 'National Park', sans-serif;
      transition: all 0.2s;
      border-radius: 4px;
    }

    .clear-filter:hover {
      background: #333;
      color: #f0f0f5;
    }

    body.dark-mode .clear-filter:hover {
      background: #f0f0f5;
      color: #333;
    }

    .chassis-container {
      margin-bottom: 40px;
    }

    .chassis-header {
      background: #9e9e9e;
      color: white;
      padding: 15px 25px;
      border-radius: 10px 10px 0 0;
      font-family: 'National Park Bold', sans-serif;
      font-size: 1.8em;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    body.dark-mode .chassis-header {
      background: #616161;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .slots-grid {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      padding: 15px 10px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      justify-content: center;
      overflow-x: visible;
    }

    body.dark-mode .slots-grid {
      background: rgba(34, 34, 34, 0.95);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .slot-card {
      border: 2px solid currentColor;
      border-radius: 6px;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex: 0 0 auto;
      width: 140px;
    }

    .slot-card:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    body.dark-mode .slot-card:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    .slot-header {
      background: #bdbdbd;
      color: white;
      padding: 10px;
      text-align: center;
      font-family: 'National Park Bold', sans-serif;
      font-size: 1.3em;
    }

    body.dark-mode .slot-header {
      background: #757575;
    }

    .ports-grid {
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: currentColor;
      padding: 0;
    }

    /* Desktop: order ports vertically 3,2,1,0 then 7,6,5,4 then 11,10,9,8 */
    .port-cell[data-port="3"] { order: 0; }
    .port-cell[data-port="2"] { order: 1; }
    .port-cell[data-port="1"] { order: 2; }
    .port-cell[data-port="0"] { order: 3; }
    .port-cell[data-port="7"] { order: 4; }
    .port-cell[data-port="6"] { order: 5; }
    .port-cell[data-port="5"] { order: 6; }
    .port-cell[data-port="4"] { order: 7; }
    .port-cell[data-port="11"] { order: 8; }
    .port-cell[data-port="10"] { order: 9; }
    .port-cell[data-port="9"] { order: 10; }
    .port-cell[data-port="8"] { order: 11; }

    .port-cell {
      background: #ffffff;
      padding: 3px 2px;
      min-height: 48px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      transition: all 0.2s;
      cursor: pointer;
    }

    body.dark-mode .port-cell {
      background: #222;
    }

    .port-cell:hover {
      background: #f5f5f5;
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    body.dark-mode .port-cell:hover {
      background: #444;
      box-shadow: 0 2px 8px rgba(255,255,255,0.1);
    }

    .port-number {
      font-weight: bold;
      color: #666;
      font-size: 0.78em;
      margin-bottom: 2px;
    }

    body.dark-mode .port-number {
      color: #bbb;
    }

    .antenna-info {
      display: flex;
      flex-direction: column;
      gap: 1px;
      width: 100%;
      text-align: center;
    }

    .grid-info {
      font-size: 0.82em;
      font-weight: bold;
      color: inherit;
      margin-bottom: 2px;
      font-family: 'National Park Bold', sans-serif;
    }

    .antenna-pol {
      font-size: 0.7em;
      padding: 2px 3px;
      border-radius: 3px;
      font-weight: normal;
    }

    .pol-p1 {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #1976d2;
    }

    .pol-p2 {
      background: #e8f5e9;
      color: #388e3c;
      border: 1px solid #388e3c;
    }

    .port-empty {
      color: #ccc;
      font-size: 0.8em;
      font-style: italic;
    }

    .port-p1 {
      background: #e3f2fd !important;
    }

    body.dark-mode .port-p1 {
      background: #1565c0 !important;
    }

    .port-p2 {
      background: #e8f5e9 !important;
    }

    body.dark-mode .port-p2 {
      background: #2e7d32 !important;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
      padding: 15px;
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid currentColor;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      flex-wrap: wrap;
    }

    body.dark-mode .legend {
      background: rgba(34, 34, 34, 0.95);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'National Park', sans-serif;
    }

    .legend-box {
      width: 30px;
      height: 30px;
      border-radius: 4px;
      border: 2px solid currentColor;
    }

    .legend-p1 {
      background: #e3f2fd;
    }

    body.dark-mode .legend-p1 {
      background: #1565c0;
    }

    .legend-p2 {
      background: #e8f5e9;
    }

    body.dark-mode .legend-p2 {
      background: #2e7d32;
    }

    .legend-empty {
      background: white;
    }

    body.dark-mode .legend-empty {
      background: #222;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
    }

    .modal-content {
      position: relative;
      margin: 10% auto;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      border-radius: 12px;
      font-family: 'National Park', sans-serif;
    }

    body.light-mode .modal-content {
      background-color: #fff;
      color: #333;
      border: 2px solid #333;
    }

    body.dark-mode .modal-content {
      background-color: #333;
      color: #f0f0f5;
      border: 2px solid #f0f0f5;
    }

    .modal-header {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 20px;
      font-family: 'National Park Bold', sans-serif;
    }

    .modal-body {
      font-size: 1.1em;
      line-height: 1.8;
    }

    .modal-row {
      display: flex;
      margin-bottom: 12px;
      border-bottom: 1px solid currentColor;
      padding-bottom: 8px;
    }

    .modal-label {
      font-weight: bold;
      min-width: 120px;
      font-family: 'National Park Bold', sans-serif;
    }

    .modal-value {
      flex: 1;
      font-family: 'National Park', monospace;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: inherit;
      border: none;
      background: none;
      padding: 0;
      line-height: 1;
    }

    .close-btn:hover {
      opacity: 0.7;
    }

    @media (max-width: 768px) {
      .slots-grid {
        flex-wrap: wrap;
        overflow-x: visible;
      }

      .slot-card {
        width: 100%;
        max-width: none;
      }

      .ports-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 1px;
      }

      /* Mobile: reset order to natural 0-11 for grid layout */
      .port-cell {
        order: initial !important;
        padding: 8px 4px;
        min-height: 60px;
      }
      
      h1 {
        font-size: 2em;
      }
      
      .chassis-header {
        font-size: 1.5em;
      }

      .filter-controls form {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-controls select,
      .clear-filter {
        width: 100%;
      }

      .legend {
        gap: 15px;
        padding: 10px;
      }

      .legend-item {
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body class="light-mode">
  <div class="fixed-toolbar">
    <a href="/" class="home-button" title="Home">‚Üê Home</a>
    <a href="/visualize/grid" class="home-button" title="Antenna Grid" style="margin-left: 10px;">Core Grid</a>
    <a href="/visualize/chains" class="home-button" title="Analog Chains" style="margin-left: 10px;">Chains</a>
    <a href="/visualize/snap-ports" class="home-button" title="SNAP Ports" style="margin-left: 10px;">SNAP Ports</a>
    <div class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle dark/light mode">
      <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon">
        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
      </svg>
      <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
    </div>
  </div>
  <div class="toolbar-spacer"></div>

  <div class="container{% if selected_chassis or selected_slot %} filtered{% endif %}">
    <h1>SNAP Ports Visualization</h1>

    <div class="filter-controls">
      <form method="get" action="/visualize/snap-ports" id="filterForm">
        <label for="chassis">Chassis:</label>
        <select name="chassis" id="chassis" onchange="document.getElementById('filterForm').submit()">
          <option value="">All Chassis</option>
          {% for c in all_chassis_list %}
          <option value="{{ c }}" {% if selected_chassis == c|string %}selected{% endif %}>Chassis {{ c }}</option>
          {% endfor %}
        </select>
        
        <label for="slot">Slot:</label>
        <select name="slot" id="slot" onchange="document.getElementById('filterForm').submit()">
          <option value="">All Slots</option>
          {% for s in all_slot_list %}
          <option value="{{ s }}" {% if selected_slot == s %}selected{% endif %}>Slot {{ s }}</option>
          {% endfor %}
        </select>
        
        <button type="button" onclick="window.location.href='/visualize/snap-ports'" class="clear-filter">Clear Filters</button>
      </form>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-box legend-p1"></div>
        <span>P1 Polarization</span>
      </div>
      <div class="legend-item">
        <div class="legend-box legend-p2"></div>
        <span>P2 Polarization</span>
      </div>
      <div class="legend-item">
        <div class="legend-box legend-empty"></div>
        <span>Empty Port</span>
      </div>
    </div>

    {% for chassis in chassis_list %}
    <div class="chassis-container">
      <div class="chassis-header">
        Chassis {{ chassis }}
      </div>
      <div class="slots-grid">
        {% for slot in slot_list %}
        <div class="slot-card">
          <div class="slot-header">
            Slot {{ slot }}
          </div>
          <div class="ports-grid">
            {% for port in range(12) %}
            {% set port_data = snap_ports[chassis][slot][port] %}
            {% set has_p1 = port_data.get('p1') %}
            {% set has_p2 = port_data.get('p2') %}
            {% set cell_class = 'port-p1' if has_p1 else ('port-p2' if has_p2 else '') %}
            {% set board_info = snap_board_info.get((chassis, slot), {}) %}
            <div class="port-cell {{ cell_class }}" data-port="{{ port }}"
                 data-chassis="{{ chassis }}" data-slot="{{ slot }}"
                 data-sn="{{ board_info.get('serial_number', '') }}"
                 data-mac="{{ board_info.get('mac_address', '') }}"
                 data-ip="{{ board_info.get('ip_address', '') }}"
                 data-feng-id="{{ board_info.get('feng_id', '') }}"
                 onclick="showSnapInfo(this)">
              <div class="port-number">ADC {{ port }}</div>
              {% if has_p1 or has_p2 %}
              <div class="antenna-info">
                {% if has_p1 %}
                <div class="grid-info">{{ has_p1.grid_code }} | {{ has_p1.kernel_index }}</div>
                <div class="antenna-pol pol-p1">P1: {{ has_p1.antenna }}</div>
                {% endif %}
                {% if has_p2 %}
                <div class="grid-info">{{ has_p2.grid_code }} | {{ has_p2.kernel_index }}</div>
                <div class="antenna-pol pol-p2">P2: {{ has_p2.antenna }}</div>
                {% endif %}
              </div>
              {% else %}
              <div class="port-empty">‚Äî</div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}

  </div>

  <!-- SNAP Board Info Modal -->
  <div id="snapModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeModal()">&times;</button>
      <div class="modal-header" id="modalHeader">SNAP Board Info</div>
      <div class="modal-body" id="modalBody">
        <!-- Content populated by JavaScript -->
      </div>
    </div>
  </div>

  <script>
    function showSnapInfo(element) {
      const chassis = element.getAttribute('data-chassis');
      const slot = element.getAttribute('data-slot');
      const port = element.getAttribute('data-port');
      const sn = element.getAttribute('data-sn');
      const mac = element.getAttribute('data-mac');
      const ip = element.getAttribute('data-ip');
      const fengId = element.getAttribute('data-feng-id');
      
      const modal = document.getElementById('snapModal');
      const header = document.getElementById('modalHeader');
      const body = document.getElementById('modalBody');
      
      header.textContent = `SNAP${chassis}${slot} - Port ${port}`;
      
      let content = `
        <div class="modal-row">
          <div class="modal-label">Chassis:</div>
          <div class="modal-value">${chassis}</div>
        </div>
        <div class="modal-row">
          <div class="modal-label">Slot:</div>
          <div class="modal-value">${slot}</div>
        </div>
        <div class="modal-row">
          <div class="modal-label">Port:</div>
          <div class="modal-value">${port}</div>
        </div>
      `;
      
      if (sn && fengId) {
        const packetIndex = parseInt(fengId) * 12 + parseInt(port);
        content += `
          <div class="modal-row">
            <div class="modal-label">Serial Number:</div>
            <div class="modal-value">${sn}</div>
          </div>
          <div class="modal-row">
            <div class="modal-label">F-Engine ID:</div>
            <div class="modal-value">${fengId}</div>
          </div>
          <div class="modal-row">
            <div class="modal-label">Packet Index:</div>
            <div class="modal-value">${packetIndex}</div>
          </div>
          <div class="modal-row">
            <div class="modal-label">MAC Address:</div>
            <div class="modal-value">${mac}</div>
          </div>
          <div class="modal-row">
            <div class="modal-label">IP Address:</div>
            <div class="modal-value">${ip}</div>
          </div>
        `;
      } else {
        content += `
          <div class="modal-row">
            <div class="modal-value" style="color: #999; font-style: italic;">
              No board configuration found
            </div>
          </div>
        `;
      }
      
      body.innerHTML = content;
      modal.style.display = 'block';
    }
    
    function closeModal(event) {
      const modal = document.getElementById('snapModal');
      if (!event || event.target === modal || event.target.classList.contains('close-btn')) {
        modal.style.display = 'none';
      }
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    function toggleDarkMode() {
      const body = document.body;
      const button = document.querySelector('.dark-mode-toggle');
      if (body.classList.contains('dark-mode')) {
        body.classList.remove('dark-mode');
        body.classList.add('light-mode');
        button.textContent = 'üåô';
        localStorage.setItem('theme', 'light');
      } else {
        body.classList.remove('light-mode');
        body.classList.add('dark-mode');
        button.textContent = '‚òÄÔ∏è';
        localStorage.setItem('theme', 'dark');
      }
    }

    // Load saved theme preference on page load
    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme');
      const body = document.body;
      const button = document.querySelector('.dark-mode-toggle');
      
      if (savedTheme === 'dark') {
        body.classList.remove('light-mode');
        body.classList.add('dark-mode');
        button.textContent = '‚òÄÔ∏è';
      } else {
        body.classList.remove('dark-mode');
        body.classList.add('light-mode');
        button.textContent = 'üåô';
      }
    });
  </script>
</body>
</html>
