<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAsMan - Part Scanner</title>
    
    <style>
        @font-face {
            font-family: 'National Park';
            src: url('/visualize/static/fonts/NationalPark-Regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'National Park Bold';
            src: url('/visualize/static/fonts/NationalPark-Bold.woff') format('woff');
            font-weight: bold;
            font-style: normal;
        }
        @font-face {
            font-family: 'National Park ExtraBold';
            src: url('/visualize/static/fonts/NationalPark-ExtraBold.woff') format('woff');
            font-weight: 900;
            font-style: normal;
        }
        
        body {
            font-family: 'National Park', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Dark mode styles */
        body.dark-mode {
            background: #000;
            color: #fff;
        }
        
        body.dark-mode button {
            border-color: #fff;
            background: #000;
            color: #fff;
        }
        
        body.dark-mode button:hover {
            background: #fff;
            color: #000;
        }
        
        body.dark-mode .button-selected {
            background: #fff !important;
            color: #000 !important;
        }
        
        body.dark-mode input,
        body.dark-mode select {
            border-color: #fff;
            background: #000;
            color: #fff;
        }
        
        body.dark-mode .section {
            border-color: #fff;
        }
        
        body.dark-mode .status-message {
            border-color: #fff;
        }
        
        body.dark-mode .status-success {
            border-color: #0f0;
            color: #0f0;
        }
        
        body.dark-mode .status-error {
            border-color: #f00;
            color: #f00;
        }
        
        body.dark-mode .status-info {
            border-color: #0ff;
            color: #0ff;
        }
        
        body.dark-mode .part-display {
            border-color: #fff;
            background-color: #111;
        }
        
        body.dark-mode .connection-item {
            border-color: #fff;
        }
        
        body.dark-mode .connection-item:hover {
            background-color: #222;
        }
        
        /* Toolbar */
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: inherit;
            border-bottom: 2px solid;
            backdrop-filter: blur(10px);
        }
        
        body.dark-mode .toolbar {
            border-bottom-color: #fff;
            background: rgba(0, 0, 0, 0.9);
        }
        
        body:not(.dark-mode) .toolbar {
            border-bottom-color: #000;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .toolbar-spacer {
            height: 70px;
        }
        
        /* Home button */
        .home-button {
            padding: 10px 15px;
            cursor: pointer;
            border: 2px solid;
            border-radius: 8px;
            background: transparent;
            text-decoration: none;
            color: inherit;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .home-button:hover {
            background: #333;
            color: #fff;
        }
        
        body.dark-mode .home-button:hover {
            background: #fff;
            color: #000;
        }
        
        /* Theme toggle button */
        .theme-toggle {
            padding: 10px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .theme-toggle .sun {
            display: none;
        }
        
        .theme-toggle .moon {
            display: inline;
        }
        
        body.dark-mode .theme-toggle .sun {
            display: inline;
        }
        
        body.dark-mode .theme-toggle .moon {
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid;
            border-radius: 12px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .button-grid button {
            padding: 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
        }
        
        /* Touch-friendly button styles for SNAP selection grids */
        #chassis-buttons button,
        #slot-buttons button,
        #slot-selection > div > div button,
        #port-buttons button {
            min-height: 60px;
            padding: 15px 20px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #333;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        #chassis-buttons button:hover,
        #slot-buttons button:hover,
        #slot-selection > div > div button:hover,
        #port-buttons button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        #chassis-buttons button:active,
        #slot-buttons button:active,
        #slot-selection > div > div button:active,
        #port-buttons button:active {
            transform: scale(0.98);
        }
        
        .connection-list {
            margin: 15px 0;
        }
        
        .connection-item {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .connection-item:hover {
            background-color: #f0f0f0;
        }
        
        .button-selected {
            background-color: #333 !important;
            color: #fff !important;
            font-weight: bold;
        }
        
        .status-message {
            padding: 15px;
            margin: 15px 0;
            border: 2px solid;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .status-success {
            border-color: green;
            color: green;
        }
        
        .status-error {
            border-color: red;
            color: red;
        }
        
        .status-info {
            border-color: blue;
            color: blue;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-family: 'National Park', sans-serif;
            border: 2px solid;
            border-radius: 8px;
        }
        
        .part-display {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
        
        .part-display h3 {
            margin-top: 0;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .nav-buttons button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <a href="/" class="home-button" title="Home">‚Üê Home</a>
        <div class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
            <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
            </svg>
            <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
        </div>
    </div>
    <div class="toolbar-spacer"></div>
    
    <h1>üîç CAsMan - Part Scanner</h1>
    <p>Web-based interface for connecting and disconnecting parts</p>
    
    <!-- Step 1: Choose Action -->
    <div id="step-action" class="section">
        <h2>Step 1: Choose Action</h2>
        <div class="button-grid">
            <button onclick="selectAction('connect')">üîó CONNECT Parts</button>
            <button onclick="selectAction('disconnect')">‚ùå DISCONNECT Parts</button>
            <button onclick="selectAction('remove')">üóëÔ∏è REMOVE Part</button>
            <button onclick="selectAction('history')">üìã Part History</button>
        </div>
    </div>
    
    <!-- Step 2: Choose Input Method -->
    <div id="step-method" class="section hidden">
        <h2>Step 2: Choose Input Method</h2>
        <div id="action-display" class="status-info status-message"></div>
        <div class="button-grid">
            <button onclick="selectMethod('barcode')">üì∑ Barcode Reader</button>
            <button onclick="selectMethod('manual')">‚å®Ô∏è Manual Entry</button>
        </div>
        <div class="nav-buttons">
            <button onclick="goToStep('action')">‚Üê Back</button>
        </div>
    </div>
    
    <!-- Step 3a: Barcode Reader Input -->
    <div id="step-barcode" class="section hidden">
        <h2>Barcode Reader Input</h2>
        <div id="barcode-instructions" class="status-info status-message"></div>
        <div class="input-group">
            <label for="barcode-input">Scan or Type Part Number:</label>
            <input type="text" id="barcode-input" placeholder="Scan barcode..." autofocus inputmode="numeric" pattern="[0-9]*">
        </div>
        <div id="barcode-status"></div>
        <div class="nav-buttons">
            <button onclick="goToStep('method')">‚Üê Back</button>
            <button onclick="switchToManualEntry()">‚å®Ô∏è Manual Entry</button>
            <button onclick="resetScanner()">üîÑ Reset</button>
        </div>
    </div>
    
    <!-- Step 3c: Manual Entry -->
    <div id="step-manual" class="section hidden">
        <h2>Manual Part Entry</h2>
        <div id="manual-instructions" class="status-info status-message"></div>
        
        <div class="input-group">
            <label>Select Part Type:</label>
            <div id="part-type-buttons" class="button-grid"></div>
        </div>
        
        <!-- Coax Cable Type Selection (for COAXSHORT/COAXLONG) -->
        <div id="coax-type-selection" class="input-group hidden">
            <label>Select Coaxial Cable Type:</label>
            <div class="button-grid">
                <button onclick="selectCoaxType('COAXSHORT')" style="padding: 20px; font-size: 18px; font-weight: bold;">üìè COAXSHORT</button>
                <button onclick="selectCoaxType('COAXLONG')" style="padding: 20px; font-size: 18px; font-weight: bold;">üìè COAXLONG</button>
            </div>
        </div>
        
        <div id="manual-polarization" class="input-group hidden">
            <label>Select Polarization:</label>
            <div id="polarization-buttons" class="button-grid">
                <button onclick="selectPolarization('1')">Polarization 1</button>
                <button onclick="selectPolarization('2')">Polarization 2</button>
            </div>
        </div>
        
        <div id="manual-number" class="input-group hidden">
            <label for="part-number-input">Enter Part Number:</label>
            <input type="number" id="part-number-input" placeholder="Enter number..." min="1" inputmode="numeric" pattern="[0-9]*">
            <button onclick="submitManualPart()" style="margin-top: 10px; width: 100%; padding: 15px;">Submit Part</button>
        </div>
        
        <div id="manual-status"></div>
        <div class="nav-buttons">
            <button onclick="goToStep('method')">‚Üê Back</button>
            <button onclick="switchToBarcodeEntry()">üì∑ Scan Barcode</button>
            <button onclick="resetScanner()">üîÑ Reset</button>
        </div>
    </div>
    
    <!-- Step 4: Connection Selection (for disconnect mode) -->
    <div id="step-select-connection" class="section hidden">
        <h2>Select Connection to Disconnect</h2>
        <div id="first-part-display" class="part-display"></div>
        <div id="connection-list-container" class="connection-list"></div>
        <div class="nav-buttons">
            <button onclick="cancelDisconnection()">‚Üê Cancel</button>
        </div>
    </div>
    
    <!-- Step 4b: SNAP Selection (for BACBOARD connections) -->
    <div id="step-snap-selection" class="section hidden">
        <h2>Enter SNAP Connection Details</h2>
        <div id="bacboard-display" class="part-display"></div>
        <div style="margin: 20px 0;">
            <h3>Select Chassis Number (1-4)</h3>
            <div id="chassis-buttons" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-width: 200px; margin: 10px auto;">
                <button onclick="selectChassis(1)">1</button>
                <button onclick="selectChassis(2)">2</button>
                <button onclick="selectChassis(3)">3</button>
                <button onclick="selectChassis(4)">4</button>
            </div>
        </div>
        <div id="slot-selection" class="hidden" style="margin: 20px 0;">
            <h3>Select SNAP Slot (A-K)</h3>
            <div style="max-width: 300px; margin: 10px auto;">
                <div id="slot-buttons" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                    <button onclick="selectSlot('A')">A</button>
                    <button onclick="selectSlot('B')">B</button>
                    <button onclick="selectSlot('C')">C</button>
                    <button onclick="selectSlot('D')">D</button>
                    <button onclick="selectSlot('E')">E</button>
                    <button onclick="selectSlot('F')">F</button>
                    <button onclick="selectSlot('G')">G</button>
                    <button onclick="selectSlot('H')">H</button>
                    <button onclick="selectSlot('I')">I</button>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; max-width: 200px; margin: 0 auto;">
                    <button onclick="selectSlot('J')">J</button>
                    <button onclick="selectSlot('K')">K</button>
                </div>
            </div>
        </div>
        <div id="port-selection" class="hidden" style="margin: 20px 0;">
            <h3>Select SNAP Port (0-11)</h3>
            <div id="port-buttons" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 400px; margin: 10px auto;">
                <button onclick="selectPort(0)">0</button>
                <button onclick="selectPort(1)">1</button>
                <button onclick="selectPort(2)">2</button>
                <button onclick="selectPort(3)">3</button>
                <button onclick="selectPort(4)">4</button>
                <button onclick="selectPort(5)">5</button>
                <button onclick="selectPort(6)">6</button>
                <button onclick="selectPort(7)">7</button>
                <button onclick="selectPort(8)">8</button>
                <button onclick="selectPort(9)">9</button>
                <button onclick="selectPort(10)">10</button>
                <button onclick="selectPort(11)">11</button>
            </div>
        </div>
        <div id="snap-status" class="status-message" style="margin: 20px 0;"></div>
        <div class="nav-buttons">
            <button onclick="cancelSnapSelection()">‚Üê Cancel</button>
        </div>
    </div>
    
    <!-- Step 5: Confirmation -->
    <div id="step-confirm" class="section hidden">
        <h2>Confirm Operation</h2>
        <div id="confirm-details" class="part-display"></div>
        <div class="nav-buttons">
            <button onclick="cancelOperation()">‚Üê Cancel</button>
            <button onclick="confirmOperation()">‚úì Confirm</button>
        </div>
    </div>
    
    <!-- Final Result -->
    <div id="step-result" class="section hidden">
        <h2>Result</h2>
        <div id="result-message" class="status-message"></div>
        <div class="nav-buttons">
            <button onclick="continueScanning()">‚ñ∂Ô∏è Continue <span id="continue-action-text"></span></button>
            <button onclick="resetScanner()">üîÑ Start Over</button>
        </div>
    </div>

    <!-- Remove Part View -->
    <!-- Step 2r: Remove - Choose Input Method -->
    <div id="step-remove-method" class="section hidden">
        <h2>Step 2: Choose Input Method</h2>
        <p style="margin: 10px 0; color: #ff6600;"><strong>‚ö†Ô∏è Warning:</strong> This will disconnect ALL connections to and from the selected part.</p>
        <div class="button-grid">
            <button onclick="selectRemoveInputMethod('barcode')">üì∑ Barcode Reader</button>
            <button onclick="selectRemoveInputMethod('manual')">‚å®Ô∏è Manual Entry</button>
        </div>
        <div class="nav-buttons">
            <button onclick="goToStep('action')">‚Üê Back</button>
        </div>
    </div>
    
    <!-- Step 3r: Remove - Barcode Input -->
    <div id="step-remove-barcode" class="section hidden">
        <h2>Remove Part - Barcode Input</h2>
        <p style="margin: 10px 0; color: #ff6600;"><strong>‚ö†Ô∏è Warning:</strong> This will disconnect ALL connections to and from the scanned part.</p>
        <div class="input-group">
            <label for="remove-barcode-input">Scan or Type Part Number:</label>
            <input type="text" id="remove-barcode-input" placeholder="Scan barcode..." autofocus>
        </div>
        <div id="remove-barcode-status"></div>
        <div class="nav-buttons">
            <button onclick="goToStep('remove-method')">‚Üê Back</button>
            <button onclick="switchToRemoveManual()">‚å®Ô∏è Manual Entry</button>
            <button onclick="resetScanner()">üîÑ Reset</button>
        </div>
    </div>
    
    <!-- Step 3r: Remove - Manual Entry -->
    <div id="step-remove-manual" class="section hidden">
        <h2>Remove Part - Manual Entry</h2>
        <p style="margin: 10px 0; color: #ff6600;"><strong>‚ö†Ô∏è Warning:</strong> This will disconnect ALL connections to and from the selected part.</p>
        
        <div class="input-group">
            <label>Select Part Type:</label>
            <div id="remove-part-type-buttons" class="button-grid"></div>
        </div>
        
        <div id="remove-polarization" class="input-group hidden">
            <label>Select Polarization:</label>
            <div id="remove-polarization-buttons" class="button-grid">
                <button onclick="selectRemovePolarization('1')">Polarization 1</button>
                <button onclick="selectRemovePolarization('2')">Polarization 2</button>
            </div>
        </div>
        
        <div id="remove-number" class="input-group hidden">
            <label for="remove-part-number-input">Enter Part Number:</label>
            <input type="number" id="remove-part-number-input" placeholder="Enter number..." min="1" inputmode="numeric" pattern="[0-9]*">
            <button onclick="submitRemovePart()" style="margin-top: 10px; width: 100%; padding: 15px;">üóëÔ∏è Remove Part</button>
        </div>
        
        <div id="remove-manual-status"></div>
        <div class="nav-buttons">
            <button onclick="goToStep('remove-method')">‚Üê Back</button>
            <button onclick="switchToRemoveBarcode()">üì∑ Scan Barcode</button>
            <button onclick="resetScanner()">üîÑ Reset</button>
        </div>
    </div>
    
    <!-- Step 4r: Remove - Confirm Removal -->
    <div id="step-remove-confirm" class="section hidden">
        <h2>Confirm Part Removal</h2>
        <div id="remove-part-display" class="part-display"></div>
        <div id="remove-connections-display" style="margin: 20px 0;"></div>
        <div class="nav-buttons">
            <button onclick="cancelRemoval()">‚Üê Cancel</button>
            <button onclick="confirmRemovePart()" id="confirm-remove-btn" style="background-color: #ff6600; color: white; font-weight: bold;">üóëÔ∏è Confirm Removal</button>
        </div>
    </div>
    
    <!-- Step 5r: Remove - Results -->
    <div id="step-remove-result" class="section hidden">
        <h2>Removal Results</h2>
        <div id="remove-results" class="status-message"></div>
        <div class="nav-buttons">
            <button onclick="resetScanner()">‚Üê Back to Menu</button>
            <button onclick="selectAction('remove')">üóëÔ∏è Remove Another Part</button>
        </div>
    </div>

    <!-- Part History View -->
    <div id="step-history" class="section hidden">
        <h2>Part History</h2>
        
        <!-- Method Selection -->
        <div id="history-method-selection" class="input-section">
            <label>Choose Input Method:</label>
            <div class="button-grid" style="margin: 15px 0;">
                <button onclick="selectHistoryMethod('text')" style="padding: 15px;">‚å®Ô∏è Type Part Number</button>
                <button onclick="selectHistoryMethod('interactive')" style="padding: 15px;">üîò Build Part Number</button>
            </div>
        </div>
        
        <!-- Text Input Method -->
        <div id="history-text-input" class="input-section hidden">
            <label for="history-part-input">Enter Part Number:</label>
            <input type="text" id="history-part-input" placeholder="e.g., BAC00001P1, SNAP1A00" style="font-size: 18px; padding: 10px; width: 100%; margin: 10px 0;">
            <button onclick="fetchPartHistory()" class="btn btn-primary btn-lg" style="width: 100%; margin-top: 10px;">üìã View History</button>
            <button onclick="selectHistoryMethod('choose')" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">‚Üê Change Method</button>
        </div>
        
        <!-- Interactive Build Method -->
        <div id="history-interactive-input" class="input-section hidden">
            <label>Select Part Type:</label>
            <div id="history-part-type-buttons" class="button-grid" style="margin: 15px 0;">
                <!-- Buttons will be dynamically generated -->
            </div>
            
            <div id="history-interactive-form" class="hidden" style="margin-top: 20px;">
                <label>Selected Type: <strong id="history-selected-type"></strong></label>
                
                <label style="margin-top: 15px;">Polarization:</label>
                <div class="button-grid" style="margin: 10px 0;">
                    <button id="history-pol-1" onclick="selectHistoryPolarization('1')" style="padding: 15px; font-size: 16px;">Polarization 1</button>
                    <button id="history-pol-2" onclick="selectHistoryPolarization('2')" style="padding: 15px; font-size: 16px;">Polarization 2</button>
                </div>
                
                <label for="history-number">Part Number (e.g., 00001):</label>
                <input type="text" id="history-number" placeholder="00001" style="font-size: 18px; padding: 10px; width: 100%; margin: 10px 0;">
                
                <div style="margin: 15px 0; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
                    <strong>Preview:</strong> <span id="history-part-preview">-</span>
                </div>
                
                <button onclick="fetchPartHistoryFromBuilder()" class="btn btn-primary btn-lg" style="width: 100%; margin-top: 10px;">üìã View History</button>
            </div>
            
            <button onclick="selectHistoryMethod('choose')" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">‚Üê Change Method</button>
        </div>
        
        <div id="history-results" class="status-message" style="margin-top: 20px;"></div>
        <div class="nav-buttons">
            <button onclick="resetScanner()">‚Üê Back to Menu</button>
        </div>
    </div>

    <script>
        // Theme management
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            // Save preference to localStorage
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        
        // Load saved theme on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        });
        
        // Global state
        let state = {
            action: null,          // 'connect' or 'disconnect'
            method: null,          // 'barcode', 'camera', 'manual'
            firstPart: null,       // {part_number, part_type, polarization}
            secondPart: null,      // {part_number, part_type, polarization}
            connections: [],       // For disconnect mode
            manualPartType: null,
            manualPolarization: null,
            coaxType: null,        // 'COAXSHORT' or 'COAXLONG' for coax cable selection
            snapChassis: null,       // SNAP chassis number (1-4)
            snapSlot: null,        // SNAP slot letter (A-K)
            snapPort: null,        // SNAP port number (0-11)
            removePart: null,      // Part being removed
            removeConnections: [], // Connections to be removed
            removePartType: null,  // Selected part type for remove manual entry
            removePolarization: null // Selected polarization for remove manual entry
        };
        
        // Function to switch between barcode and manual entry
        function switchToManualEntry() {
            state.method = 'manual';
            setupManualEntry();
            goToStep('manual');
        }
        
        function switchToBarcodeEntry() {
            state.method = 'barcode';
            setupBarcodeInput();
            goToStep('barcode');
        }
        
        // Part types from server
        const partTypes = {{ part_types | tojson }};
        
        // Navigation functions
        function goToStep(step) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById('step-' + step).classList.remove('hidden');
        }
        
        function selectAction(action) {
            state.action = action;
            
            // History action goes directly to history view
            if (action === 'history') {
                goToStep('history');
                // Focus on input field
                setTimeout(() => {
                    document.getElementById('history-part-input').focus();
                }, 100);
                return;
            }
            
            // Remove action goes to method selection
            if (action === 'remove') {
                goToStep('remove-method');
                return;
            }
            
            document.getElementById('action-display').textContent = 
                `Selected: ${action.toUpperCase()} parts`;
            goToStep('method');
        }
        
        function selectMethod(method) {
            state.method = method;
            
            if (method === 'barcode') {
                setupBarcodeInput();
                goToStep('barcode');
            } else if (method === 'manual') {
                setupManualEntry();
                goToStep('manual');
            }
        }
        
        function resetScanner() {
            state = {
                action: null,
                method: null,
                firstPart: null,
                secondPart: null,
                connections: [],
                manualPartType: null,
                manualPolarization: null,
                coaxType: null,
                snapChassis: null,
                snapSlot: null,
                snapPort: null,
                removePart: null,
                removeConnections: [],
                removePartType: null,
                removePolarization: null
            };
            // Clear all button selections
            document.querySelectorAll('.button-selected').forEach(btn => {
                btn.classList.remove('button-selected');
            });
            // Clear history input and results
            const historyInput = document.getElementById('history-part-input');
            const historyResults = document.getElementById('history-results');
            if (historyInput) historyInput.value = '';
            if (historyResults) historyResults.innerHTML = '';
            
            goToStep('action');
        }
        
        function continueScanning() {
            // Keep the action and method, but reset the parts
            const currentAction = state.action;
            const currentMethod = state.method;
            
            state = {
                action: currentAction,
                method: currentMethod,
                firstPart: null,
                secondPart: null,
                connections: [],
                manualPartType: null,
                manualPolarization: null
            };
            
            // Clear all button selections
            document.querySelectorAll('.button-selected').forEach(btn => {
                btn.classList.remove('button-selected');
            });
            
            // Go directly to the scanning step
            if (currentMethod === 'barcode') {
                setupBarcodeInput();
                goToStep('barcode');
            } else if (currentMethod === 'manual') {
                setupManualEntry();
                goToStep('manual');
            }
        }
        
        // Barcode reader mode
        function setupBarcodeInput() {
            const input = document.getElementById('barcode-input');
            const instructions = document.getElementById('barcode-instructions');
            const statusDiv = document.getElementById('barcode-status');
            
            // Clear previous status message
            statusDiv.innerHTML = '';
            
            if (state.action === 'connect') {
                if (!state.firstPart) {
                    instructions.innerHTML = 'üìã Scan FIRST part (source of connection)<br><small>Note: After LNA, you\'ll need to manually enter COAX parts (no barcodes)</small>';
                } else {
                    const nextPartType = getNextPartInChain(state.firstPart.part_type);
                    let extraInfo = '';
                    if (nextPartType === 'COAXSHORT' || nextPartType === 'COAXLONG') {
                        extraInfo = '<br>‚ö†Ô∏è COAX parts have no barcode - will switch to manual entry';
                    } else if (nextPartType === 'BACBOARD') {
                        extraInfo = '<br>üí° Can scan barcode OR use manual entry button';
                    }
                    instructions.innerHTML = `
                        <strong>Just scanned:</strong> ${state.firstPart.part_number}<br>
                        <strong>Connecting to:</strong> ${nextPartType}${extraInfo}<br>
                        Scan the ${nextPartType} part
                    `;
                }
            } else {
                instructions.textContent = 'üìã Scan part to disconnect';
            }
            
            input.value = '';
            input.focus();
            
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    const partNumber = input.value.trim();
                    if (partNumber) {
                        processBarcodeInput(partNumber);
                    }
                }
            };
        }
        
        // Determine next part type in the connection chain
        function getNextPartInChain(currentType) {
            const chain = {
                'ANTENNA': 'LNA',
                'LNA': 'COAXSHORT',
                'COAXSHORT': 'COAXLONG',
                'COAXLONG': 'BACBOARD',
                'BACBOARD': 'SNAP'
            };
            return chain[currentType] || 'SNAP';
        }
        
        async function processBarcodeInput(partNumber) {
            const statusDiv = document.getElementById('barcode-status');
            statusDiv.innerHTML = '<div class="status-info status-message">‚è≥ Validating part...</div>';
            
            try {
                const response = await fetch('/scanner/api/validate-part', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({part_number: partNumber})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const partInfo = {
                        part_number: result.part_number,
                        part_type: result.part_type,
                        polarization: result.polarization,
                        existing_connections: result.existing_connections || []
                    };
                    
                    handlePartScanned(partInfo);
                } else {
                    statusDiv.innerHTML = `<div class="status-error status-message">‚ùå ${result.error}</div>`;
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                        document.getElementById('barcode-input').value = '';
                        document.getElementById('barcode-input').focus();
                    }, 2000);
                }
            } catch (error) {
                let errorMsg = error.message;
                if (errorMsg.includes('Failed to fetch') || errorMsg.includes('Load failed') || errorMsg.includes('NetworkError')) {
                    errorMsg = 'Cannot connect to server. Check network connection and server URL.';
                }
                statusDiv.innerHTML = `<div class="status-error status-message">‚ùå ${errorMsg}</div>`;
            }
        }
        
        // Manual entry mode
        function setupManualEntry() {
            const instructions = document.getElementById('manual-instructions');
            const statusDiv = document.getElementById('manual-status');
            
            // Clear previous status message
            statusDiv.innerHTML = '';
            
            if (state.action === 'connect') {
                if (!state.firstPart) {
                    instructions.textContent = '‚å®Ô∏è Enter FIRST part details (source)';
                } else {
                    // Show what was scanned and determine next expected part
                    const nextPartType = getNextPartInChain(state.firstPart.part_type);
                    instructions.innerHTML = `
                        <strong>Just scanned:</strong> ${state.firstPart.part_number}<br>
                        <strong>Connecting to:</strong> ${nextPartType}<br>
                        Enter part number for ${nextPartType}
                    `;
                }
            } else {
                instructions.textContent = '‚å®Ô∏è Enter part details to disconnect';
            }
            
            // Create part type buttons
            const buttonContainer = document.getElementById('part-type-buttons');
            buttonContainer.innerHTML = '';
            
            // If we have first part, only show valid next parts
            let availableTypes = partTypes;
            if (state.action === 'connect' && state.firstPart) {
                const nextType = getNextPartInChain(state.firstPart.part_type);
                availableTypes = [nextType];
            } else if (state.action === 'connect' && !state.firstPart) {
                // In connect mode without first part, exclude SNAP (terminal connection)
                availableTypes = partTypes.filter(type => type !== 'SNAP');
            }
            // In disconnect mode, show all types including SNAP
            
            availableTypes.forEach(type => {
                const btn = document.createElement('button');
                btn.textContent = type;
                btn.onclick = () => selectPartType(type);
                buttonContainer.appendChild(btn);
            });
            
            // Clear previous selections
            document.querySelectorAll('.button-selected').forEach(btn => {
                btn.classList.remove('button-selected');
            });
            
            // Show/hide appropriate sections
            document.getElementById('part-type-buttons').parentElement.classList.remove('hidden');
            document.getElementById('coax-type-selection').classList.add('hidden');
            document.getElementById('manual-polarization').classList.add('hidden');
            document.getElementById('manual-number').classList.add('hidden');
        }
        
        // Function to prompt user for coax cable entry
        function promptForCoaxEntry(expectedCoaxType) {
            goToStep('manual');
            
            const instructionsDiv = document.getElementById('manual-instructions');
            instructionsDiv.innerHTML = `
                <strong>Just scanned:</strong> ${state.firstPart.part_number} (${state.firstPart.part_type})<br>
                <strong>Next:</strong> ${expectedCoaxType}<br>
                ‚ö†Ô∏è ${expectedCoaxType} parts have no barcode - manual entry required
            `;
            
            // Hide part type selection and show coax type selection
            document.getElementById('part-type-buttons').parentElement.classList.add('hidden');
            document.getElementById('coax-type-selection').classList.remove('hidden');
            document.getElementById('manual-polarization').classList.add('hidden');
            document.getElementById('manual-number').classList.add('hidden');
            document.getElementById('manual-status').innerHTML = '';
            
            // Clear previous selections
            state.coaxType = null;
            state.manualPolarization = null;
            
            // Show only the expected coax type button, hide the other
            const buttons = document.querySelectorAll('#coax-type-selection button');
            buttons.forEach(btn => {
                btn.classList.remove('button-selected');
                btn.style.border = '';
                btn.style.display = '';
                
                if (btn.textContent.includes(expectedCoaxType)) {
                    // Show and auto-select the expected button
                    btn.style.display = 'block';
                    btn.classList.add('button-selected');
                    // Auto-select this coax type
                    state.coaxType = expectedCoaxType;
                    state.manualPartType = expectedCoaxType;
                } else {
                    // Hide the other button
                    btn.style.display = 'none';
                }
            });
            
            // Since the coax type is auto-selected, show polarization immediately
            document.getElementById('manual-polarization').classList.remove('hidden');
        }
        
        function selectCoaxType(coaxType) {
            state.coaxType = coaxType;
            state.manualPartType = coaxType;
            
            // Highlight selected button
            document.querySelectorAll('#coax-type-selection button').forEach(btn => {
                btn.classList.remove('button-selected');
                btn.style.border = '';
            });
            event.target.classList.add('button-selected');
            
            // Show polarization selection
            document.getElementById('manual-polarization').classList.remove('hidden');
            document.getElementById('manual-number').classList.add('hidden');
        }
        
        function selectPartType(type) {
            state.manualPartType = type;
            
            // Highlight selected button
            document.querySelectorAll('#part-type-buttons button').forEach(btn => {
                btn.classList.remove('button-selected');
            });
            event.target.classList.add('button-selected');
            
            if (type === 'SNAP') {
                // SNAP parts use the crate/slot/port selection interface
                // Hide manual entry and show SNAP selection
                document.getElementById('step-manual').classList.add('hidden');
                document.getElementById('step-snap-selection').classList.remove('hidden');
                
                // Update display based on mode
                const displayDiv = document.getElementById('bacboard-display');
                if (state.action === 'disconnect') {
                    displayDiv.innerHTML = '<div class="part-display"><strong>Selecting SNAP part to disconnect</strong></div>';
                } else {
                    displayDiv.innerHTML = '<div class="part-display">BACBOARD not scanned - Direct SNAP selection</div>';
                }
            } else if (type === 'COAXSHORT' || type === 'COAXLONG') {
                // Coax cables go through special selection
                selectCoaxType(type);
            } else {
                document.getElementById('manual-polarization').classList.remove('hidden');
                document.getElementById('manual-number').classList.add('hidden');
            }
        }
        
        function selectPolarization(pol) {
            state.manualPolarization = pol;
            
            // Highlight selected button
            document.querySelectorAll('#polarization-buttons button').forEach(btn => {
                btn.classList.remove('button-selected');
            });
            event.target.classList.add('button-selected');
            
            document.getElementById('manual-number').classList.remove('hidden');
            document.getElementById('part-number-input').focus();
        }
        
        async function submitManualPart() {
            const partNum = document.getElementById('part-number-input').value;
            
            if (!partNum || !state.manualPartType) {
                alert('Please complete all fields');
                return;
            }
            
            // SNAP parts now use the dedicated crate/slot/port selection interface
            // This function only handles regular parts
            let partNumber;
            const prefix = {
                'ANTENNA': 'ANT',
                'LNA': 'LNA',
                'COAXSHORT': 'CXS',
                'COAXLONG': 'CXL',
                'BACBOARD': 'BAC'
            }[state.manualPartType];
            partNumber = `${prefix}${String(partNum).padStart(5, '0')}P${state.manualPolarization}`;
            
            const statusDiv = document.getElementById('manual-status');
            statusDiv.innerHTML = '<div class="status-info status-message">‚è≥ Validating part...</div>';
            
            try {
                const response = await fetch('/scanner/api/validate-part', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({part_number: partNumber})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const partInfo = {
                        part_number: result.part_number,
                        part_type: result.part_type,
                        polarization: result.polarization,
                        existing_connections: result.existing_connections || []
                    };
                    
                    handlePartScanned(partInfo);
                } else {
                    statusDiv.innerHTML = `<div class="status-error status-message">‚ùå ${result.error}</div>`;
                }
            } catch (error) {
                let errorMsg = error.message;
                if (errorMsg.includes('Failed to fetch') || errorMsg.includes('Load failed') || errorMsg.includes('NetworkError')) {
                    errorMsg = 'Cannot connect to server. Check network connection and server URL.';
                }
                statusDiv.innerHTML = `<div class="status-error status-message">‚ùå ${errorMsg}</div>`;
            }
        }
        
        // Handle scanned/entered part
        async function handlePartScanned(partInfo) {
            if (state.action === 'connect') {
                handleConnectMode(partInfo);
            } else {
                handleDisconnectMode(partInfo);
            }
        }
        
        function handleConnectMode(partInfo) {
            if (!state.firstPart) {
                // First part scanned - check for existing connections
                state.firstPart = partInfo;
                
                const statusDiv = state.method === 'barcode' ?
                    document.getElementById('barcode-status') :
                    document.getElementById('manual-status');
                
                // Check if part already has an outgoing connection
                let hasOutgoingConnection = false;
                if (partInfo.existing_connections && partInfo.existing_connections.length > 0) {
                    const connections = partInfo.existing_connections;
                    let connMsg = `<div class="status-info status-message">‚ÑπÔ∏è Part ${partInfo.part_number} has existing connections:<br>`;
                    connections.forEach(conn => {
                        if (conn.part_number === partInfo.part_number) {
                            connMsg += `‚Ä¢ Connected to: ${conn.connected_to} (${conn.connected_to_type})<br>`;
                            hasOutgoingConnection = true;
                        } else {
                            connMsg += `‚Ä¢ Connected from: ${conn.part_number}<br>`;
                        }
                    });
                    connMsg += '</div>';
                    statusDiv.innerHTML = connMsg;
                    
                    // If part already has outgoing connection, cannot connect another part to it
                    if (hasOutgoingConnection) {
                        setTimeout(() => {
                            statusDiv.innerHTML = `<div class="status-error status-message">‚ùå ${partInfo.part_number} already has an outgoing connection. Cannot add another connection.</div>`;
                            setTimeout(() => {
                                state.firstPart = null;
                                statusDiv.innerHTML = '';
                                if (state.method === 'barcode') {
                                    setupBarcodeInput();
                                } else if (state.method === 'manual') {
                                    setupManualEntry();
                                }
                            }, 3000);
                        }, 2000);
                        return;
                    }
                } else {
                    statusDiv.innerHTML = `<div class="status-success status-message">‚úì Part ${partInfo.part_number} found in database</div>`;
                }
                
                // If first part is LNA, automatically go to coax manual entry (no barcode)
                if (partInfo.part_type === 'LNA') {
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                        state.method = 'manual';
                        // Show coax selection directly
                        promptForCoaxEntry('COAXSHORT');
                    }, 1500);
                    return;
                }
                
                // If first part is COAXSHORT, prompt for COAXLONG
                if (partInfo.part_type === 'COAXSHORT') {
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                        state.method = 'manual';
                        promptForCoaxEntry('COAXLONG');
                    }, 1500);
                    return;
                }
                
                // If first part is COAXLONG, give option to scan or manually enter BACBOARD
                if (partInfo.part_type === 'COAXLONG') {
                    setTimeout(() => {
                        statusDiv.innerHTML = '<div class="status-info status-message">üìã Next: BACBOARD<br>Choose to scan barcode or enter manually</div>';
                        // Stay in current method (user can switch using buttons)
                        if (state.method === 'barcode') {
                            setupBarcodeInput();
                        } else {
                            setupManualEntry();
                        }
                    }, 1500);
                    return;
                }
                
                // If first part is BACBOARD, show SNAP crate/slot selection
                if (partInfo.part_type === 'BACBOARD') {
                    setTimeout(() => {
                        showSnapSelection();
                    }, 1500);
                    return;
                }
                
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                    if (state.method === 'barcode') {
                        setupBarcodeInput();
                    } else if (state.method === 'manual') {
                        state.manualPartType = null;
                        state.manualPolarization = null;
                        setupManualEntry();
                    }
                }, 3000);
            } else {
                // Second part scanned - check if already connected
                state.secondPart = partInfo;
                
                const statusDiv = state.method === 'barcode' ?
                    document.getElementById('barcode-status') :
                    document.getElementById('manual-status');
                
                // Check if this connection already exists (bidirectional)
                let alreadyConnected = false;
                let hasIncomingConnection = false;
                
                if (partInfo.existing_connections) {
                    for (const conn of partInfo.existing_connections) {
                        // Check if these exact parts are already connected
                        if ((conn.part_number === state.firstPart.part_number && conn.connected_to === partInfo.part_number) ||
                            (conn.part_number === partInfo.part_number && conn.connected_to === state.firstPart.part_number)) {
                            alreadyConnected = true;
                            break;
                        }
                        // Check if second part already has an incoming connection from someone else
                        if (conn.connected_to === partInfo.part_number && conn.part_number !== state.firstPart.part_number) {
                            hasIncomingConnection = true;
                        }
                    }
                }
                
                if (alreadyConnected) {
                    statusDiv.innerHTML = `<div class="status-error status-message">‚ùå ${state.firstPart.part_number} is already connected to ${partInfo.part_number}</div>`;
                    setTimeout(() => {
                        // Reset to scan second part again
                        state.secondPart = null;
                        statusDiv.innerHTML = '';
                        if (state.method === 'barcode') {
                            setupBarcodeInput();
                        } else if (state.method === 'manual') {
                            setupManualEntry();
                        }
                    }, 3000);
                } else if (hasIncomingConnection) {
                    statusDiv.innerHTML = `<div class="status-error status-message">‚ùå ${partInfo.part_number} already has an incoming connection from another part. Cannot add another connection.</div>`;
                    setTimeout(() => {
                        // Reset to scan second part again
                        state.secondPart = null;
                        statusDiv.innerHTML = '';
                        if (state.method === 'barcode') {
                            setupBarcodeInput();
                        } else if (state.method === 'manual') {
                            setupManualEntry();
                        }
                    }, 3000);
                } else {
                    statusDiv.innerHTML = `<div class="status-success status-message">‚úì Part ${partInfo.part_number} found in database</div>`;
                    setTimeout(() => {
                        showConfirmation();
                    }, 1000);
                }
            }
        }
        
        async function handleDisconnectMode(partInfo) {
            state.firstPart = partInfo;
            
            // Show success message
            const statusDiv = state.method === 'barcode' ? 
                document.getElementById('barcode-status') : 
                document.getElementById('manual-status');
            statusDiv.innerHTML = `<div class="status-success status-message">‚úì Part ${partInfo.part_number} found in database</div>`;
            
            // Get existing connections
            try {
                const response = await fetch('/scanner/api/get-connections', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({part_number: partInfo.part_number})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.count === 0) {
                        statusDiv.innerHTML = '';
                        alert(`Part ${partInfo.part_number} has no active connections to disconnect.`);
                        resetScanner();
                        return;
                    }
                    
                    state.connections = result.connections;
                    setTimeout(() => {
                        showConnectionSelection();
                    }, 1000);
                } else {
                    statusDiv.innerHTML = '';
                    alert(`Error: ${result.error}`);
                    resetScanner();
                }
            } catch (error) {
                statusDiv.innerHTML = '';
                alert(`Error: ${error.message}`);
                resetScanner();
            }
        }
        
        // Show SNAP crate/slot/port selection for BACBOARD
        function showSnapSelection() {
            const displayDiv = document.getElementById('bacboard-display');
            displayDiv.innerHTML = `
                <h3>BACBOARD to Connect:</h3>
                <p><strong>Part Number:</strong> ${state.firstPart.part_number}</p>
                <p><strong>Type:</strong> ${state.firstPart.part_type}</p>
                <p><strong>Polarization:</strong> ${state.firstPart.polarization}</p>
                <p style="margin-top: 15px; font-style: italic;">This is the last part in the sequence. It must be connected to a SNAP board.</p>
            `;
            
            // Reset button selections
            document.querySelectorAll('.button-selected').forEach(btn => {
                btn.classList.remove('button-selected');
            });
            
            // Reset state
            state.snapChassis = null;
            state.snapSlot = null;
            state.snapPort = null;
            
            document.getElementById('slot-selection').classList.add('hidden');
            document.getElementById('port-selection').classList.add('hidden');
            document.getElementById('snap-status').innerHTML = '';
            
            goToStep('snap-selection');
        }
        
        function selectChassis(chassis) {
            state.snapChassis = chassis;
            
            // Highlight selected button
            document.querySelectorAll('#chassis-buttons button').forEach(btn => {
                btn.classList.remove('button-selected');
            });
            event.target.classList.add('button-selected');
            
            // Show slot selection
            document.getElementById('slot-selection').classList.remove('hidden');
            document.getElementById('snap-status').innerHTML = `<div class="status-info">Selected Chassis: ${chassis}</div>`;
        }
        
        async function selectSlot(slot) {
            state.snapSlot = slot;
            
            // Highlight selected button
            document.querySelectorAll('#slot-buttons button').forEach(btn => {
                btn.classList.remove('button-selected');
            });
            event.target.classList.add('button-selected');
            
            const statusDiv = document.getElementById('snap-status');
            statusDiv.innerHTML = `<div class="status-info">‚è≥ Checking available ports for Chassis ${state.snapChassis}, Slot ${slot}...</div>`;
            
            // Check which ports are already occupied
            try {
                const response = await fetch('/scanner/api/check-snap-ports', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chassis: state.snapChassis,
                        slot: slot
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show port selection
                    document.getElementById('port-selection').classList.remove('hidden');
                    
                    const occupiedPorts = result.occupied_ports || {};
                    const isDisconnectMode = state.action === 'disconnect';
                    
                    // Reset all buttons first
                    document.querySelectorAll('#port-buttons button').forEach(btn => {
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.classList.remove('button-selected');
                        btn.classList.remove('port-occupied');
                        btn.classList.remove('port-available');
                        btn.classList.remove('port-connected');
                        btn.title = '';
                        btn.removeAttribute('data-occupied');
                        btn.removeAttribute('data-port');
                    });
                    
                    if (isDisconnectMode) {
                        // In disconnect mode: grey out UNOCCUPIED ports, allow occupied ports
                        const occupiedPortNums = Object.keys(occupiedPorts);
                        
                        document.querySelectorAll('#port-buttons button').forEach(btn => {
                            const portNum = btn.getAttribute('onclick').match(/\d+/)[0];
                            
                            if (occupiedPortNums.includes(portNum)) {
                                // Port is occupied - make it selectable (DO NOT add port-occupied class)
                                const portInfo = occupiedPorts[portNum];
                                btn.classList.add('port-connected');  // Use different class for disconnect mode
                                btn.title = `Connected to ${portInfo.connected_to} - Click to disconnect`;
                                btn.setAttribute('data-occupied', portInfo.connected_to);
                                btn.setAttribute('data-port', portNum);
                            } else {
                                // Port is free - grey it out
                                btn.style.opacity = '0.4';
                                btn.style.cursor = 'not-allowed';
                                btn.classList.add('port-available');
                                btn.title = 'No connection to disconnect';
                            }
                        });
                        
                        const occupiedCount = occupiedPortNums.length;
                        if (occupiedCount > 0) {
                            let portDetails = occupiedPortNums.map(portNum => {
                                return `Port ${portNum}: ${occupiedPorts[portNum].connected_to}`;
                            }).join('<br>');
                            statusDiv.innerHTML = `<div class="status-info">Selected: Chassis ${state.snapChassis}, Slot ${slot}<br><small>${occupiedCount} port(s) connected (select to disconnect):</small><br><small>${portDetails}</small></div>`;
                        } else {
                            statusDiv.innerHTML = `<div class="status-info">Selected: Chassis ${state.snapChassis}, Slot ${slot}<br><small>No ports connected</small></div>`;
                        }
                    } else {
                        // In connect mode: grey out OCCUPIED ports, allow free ports
                        Object.keys(occupiedPorts).forEach(portNum => {
                            const portInfo = occupiedPorts[portNum];
                            const portButton = document.querySelector(`#port-buttons button[onclick="selectPort(${portNum})"]`);
                            if (portButton) {
                                portButton.style.opacity = '0.4';
                                portButton.style.cursor = 'not-allowed';
                                portButton.classList.add('port-occupied');
                                portButton.title = `Port already connected to ${portInfo.connected_to}`;
                                portButton.setAttribute('data-occupied', portInfo.connected_to);
                                portButton.setAttribute('data-port', portNum);
                            }
                        });
                        
                        const occupiedCount = Object.keys(occupiedPorts).length;
                        if (occupiedCount > 0) {
                            let portDetails = Object.keys(occupiedPorts).map(portNum => {
                                return `Port ${portNum}: ${occupiedPorts[portNum].connected_to}`;
                            }).join('<br>');
                            statusDiv.innerHTML = `<div class="status-info">Selected: Chassis ${state.snapChassis}, Slot ${slot}<br><small>${occupiedCount} port(s) already connected:</small><br><small>${portDetails}</small></div>`;
                        } else {
                            statusDiv.innerHTML = `<div class="status-info">Selected: Chassis ${state.snapChassis}, Slot ${slot}<br><small>All ports available</small></div>`;
                        }
                    }
                } else {
                    statusDiv.innerHTML = `<div class="status-error">‚ùå ${result.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-error">‚ùå Error checking ports: ${error.message}</div>`;
            }
        }
        
        async function selectPort(port) {
            const statusDiv = document.getElementById('snap-status');
            const clickedButton = event.target;
            const isDisconnectMode = state.action === 'disconnect';
            
            console.log('selectPort called - port:', port, 'state.action:', state.action, 'isDisconnectMode:', isDisconnectMode);
            console.log('Button classes:', clickedButton.classList.toString());
            
            // In disconnect mode, only allow occupied ports
            // In connect mode, only allow available ports
            if (isDisconnectMode) {
                // Disconnect mode: check if port is available (greyed out)
                if (clickedButton.classList.contains('port-available')) {
                    statusDiv.innerHTML = `<div class="status-error">‚ùå Port ${port} has no connection to disconnect</div>`;
                    setTimeout(() => {
                        statusDiv.innerHTML = `<div class="status-info">Selected: Chassis ${state.snapChassis}, Slot ${state.snapSlot}<br><small>Please select a connected port</small></div>`;
                    }, 3000);
                    return;
                }
            } else {
                // Connect mode: check if port is occupied (greyed out)
                if (clickedButton.classList.contains('port-occupied')) {
                    const connectedTo = clickedButton.getAttribute('data-occupied');
                    const portNum = clickedButton.getAttribute('data-port');
                    statusDiv.innerHTML = `<div class="status-error">‚ùå Port ${portNum} already connected to ${connectedTo}</div>`;
                    setTimeout(() => {
                        statusDiv.innerHTML = `<div class="status-info">Selected: Chassis ${state.snapChassis}, Slot ${state.snapSlot}<br><small>Please select an available port</small></div>`;
                    }, 3000);
                    return;
                }
            }
            
            state.snapPort = port;
            
            // Highlight selected button
            document.querySelectorAll('#port-buttons button').forEach(btn => {
                btn.classList.remove('button-selected');
            });
            clickedButton.classList.add('button-selected');
            
            statusDiv.innerHTML = `<div class="status-info">‚è≥ Formatting SNAP part: ${state.snapChassis}${state.snapSlot}${String(port).padStart(2, '0')}...</div>`;
            
            try {
                // Format SNAP part
                const response = await fetch('/scanner/api/format-snap', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chassis: state.snapChassis,
                        slot: state.snapSlot,
                        port: port,
                        action: state.action  // Pass the current action (connect/disconnect)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // In disconnect mode, show what's connected and provide disconnect button
                    if (state.action === 'disconnect' && result.connected_to) {
                        statusDiv.innerHTML = `
                            <div class="status-success">
                                <div style="margin-bottom: 15px;">
                                    <strong>${result.snap_part}</strong> is connected to:
                                </div>
                                <button id="disconnect-snap-btn" class="btn btn-danger btn-lg" style="width: 100%; padding: 15px; font-size: 18px;">
                                    Disconnect from ${result.connected_to}
                                </button>
                            </div>`;
                        
                        // Add event listener to the button (safer than inline onclick)
                        setTimeout(() => {
                            const disconnectBtn = document.getElementById('disconnect-snap-btn');
                            if (disconnectBtn) {
                                disconnectBtn.addEventListener('click', async function(e) {
                                    await confirmDisconnection(result.snap_part, result.connected_to, e);
                                });
                            }
                        }, 0);
                    } else {
                        // Connect mode: proceed as normal
                        statusDiv.innerHTML = `<div class="status-success">‚úì SNAP Part: ${result.snap_part}</div>`;
                        
                        // Set as second part
                        state.secondPart = {
                            part_number: result.snap_part,
                            part_type: result.part_type,
                            polarization: result.polarization,
                            existing_connections: []
                        };
                        
                        setTimeout(() => {
                            showConfirmation();
                        }, 1000);
                    }
                } else {
                    statusDiv.innerHTML = `<div class="status-error">‚ùå ${result.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function confirmDisconnection(snapPart, connectedTo, evt) {
            const statusDiv = document.getElementById('snap-status');
            
            // Disable the button immediately to prevent double-clicks
            const clickedButton = evt.target;
            clickedButton.disabled = true;
            clickedButton.style.opacity = '0.5';
            clickedButton.style.cursor = 'not-allowed';
            clickedButton.textContent = '‚è≥ Processing...';
            
            // Show processing message
            statusDiv.innerHTML = '<div class="status-info">‚è≥ Recording disconnection...</div>';
            
            try {
                // Determine part types from part numbers
                const snapType = 'SNAP';
                const connectedType = connectedTo.startsWith('BAC') ? 'BACBOARD' : 
                                     connectedTo.startsWith('ANT') ? 'ANTENNA' : 
                                     connectedTo.startsWith('CXL') ? 'COAXLONG' :
                                     connectedTo.startsWith('CXS') ? 'COAXSHORT' :
                                     connectedTo.startsWith('LNA') ? 'LNA' : 'UNKNOWN';
                
                // Record the disconnection
                const response = await fetch('/scanner/api/record-disconnection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        part_number: snapPart,
                        part_type: snapType,
                        polarization: 'N/A',
                        connected_to: connectedTo,
                        connected_to_type: connectedType,
                        connected_polarization: 'N/A'
                    })
                });
                
                const result = await response.json();
                
                console.log('Disconnection result:', result);
                
                if (result.success) {
                    // Show success and navigate to result page
                    state.secondPart = {
                        part_number: connectedTo,
                        part_type: connectedType,
                        polarization: 'N/A'
                    };
                    state.firstPart = {
                        part_number: snapPart,
                        part_type: snapType,
                        polarization: 'N/A'
                    };
                    
                    // Hide SNAP selection and show result
                    document.getElementById('step-snap-selection').classList.add('hidden');
                    document.getElementById('result-message').innerHTML = `
                        <div class="status-success status-message">
                            ‚úì Successfully disconnected ${snapPart} from ${connectedTo}
                        </div>`;
                    document.getElementById('continue-action-text').textContent = 'Disconnecting';
                    goToStep('result');
                } else {
                    statusDiv.innerHTML = `<div class="status-error">‚ùå ${result.error}</div>`;
                    // Re-enable button on error
                    clickedButton.disabled = false;
                    clickedButton.style.opacity = '1';
                    clickedButton.style.cursor = 'pointer';
                }
            } catch (error) {
                console.error('Disconnection error:', error);
                statusDiv.innerHTML = `<div class="status-error">‚ùå Error: ${error.message}</div>`;
                // Re-enable button on error
                clickedButton.disabled = false;
                clickedButton.style.opacity = '1';
                clickedButton.style.cursor = 'pointer';
            }
        }
        
        function resetForNewDisconnection() {
            // Reset state for another disconnection
            state.snapChassis = null;
            state.snapSlot = null;
            state.snapPort = null;
            state.firstPart = null;
            state.secondPart = null;
            
            // Go back to action selection
            goToStep('action');
        }
        
        async function fetchPartHistory() {
            const partInput = document.getElementById('history-part-input');
            const partNumber = partInput.value.trim().toUpperCase();
            
            if (!partNumber) {
                document.getElementById('history-results').innerHTML = '<div class="status-error">‚ùå Please enter a part number</div>';
                return;
            }
            
            fetchPartHistoryByNumber(partNumber);
        }
        
        // Allow Enter key to trigger history fetch
        document.addEventListener('DOMContentLoaded', function() {
            const historyInput = document.getElementById('history-part-input');
            if (historyInput) {
                historyInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        fetchPartHistory();
                    }
                });
            }
        });
        
        function selectHistoryMethod(method) {
            // Hide all input methods
            document.getElementById('history-method-selection').classList.add('hidden');
            document.getElementById('history-text-input').classList.add('hidden');
            document.getElementById('history-interactive-input').classList.add('hidden');
            
            if (method === 'choose') {
                // Show method selection
                document.getElementById('history-method-selection').classList.remove('hidden');
                document.getElementById('history-results').innerHTML = '';
            } else if (method === 'text') {
                // Show text input
                document.getElementById('history-text-input').classList.remove('hidden');
                document.getElementById('history-part-input').focus();
            } else if (method === 'interactive') {
                // Show interactive builder
                document.getElementById('history-interactive-input').classList.remove('hidden');
                
                // Generate part type buttons
                const buttonsDiv = document.getElementById('history-part-type-buttons');
                buttonsDiv.innerHTML = '';
                
                partTypes.forEach(partType => {
                    if (partType !== 'SNAP') {
                        const btn = document.createElement('button');
                        btn.textContent = partType;
                        btn.onclick = () => selectPartTypeForHistory(partType);
                        btn.style.padding = '15px';
                        btn.style.fontSize = '16px';
                        buttonsDiv.appendChild(btn);
                    }
                });
            }
        }
        
        let selectedHistoryPartType = null;
        let selectedHistoryAbbrev = null;
        let selectedHistoryPolarization = '1'; // Default to polarization 1
        
        // Map part types to their abbreviations
        const partTypeAbbrev = {
            'ANTENNA': 'ANT',
            'LNA': 'LNA',
            'COAXSHORT': 'CXS',
            'COAXLONG': 'CXL',
            'BACBOARD': 'BAC'
        };
        
        function selectPartTypeForHistory(partType) {
            selectedHistoryPartType = partType;
            selectedHistoryAbbrev = partTypeAbbrev[partType];
            selectedHistoryPolarization = '1'; // Reset to default
            
            // Highlight selected button
            const buttons = document.querySelectorAll('#history-part-type-buttons button');
            buttons.forEach(btn => {
                btn.style.backgroundColor = '';
                btn.style.color = '';
            });
            event.target.style.backgroundColor = '#007bff';
            event.target.style.color = 'white';
            
            // Show the form
            document.getElementById('history-interactive-form').classList.remove('hidden');
            document.getElementById('history-selected-type').textContent = partType;
            
            // Highlight default polarization
            selectHistoryPolarization('1');
            
            // Add event listener for live preview on number input
            const numberInput = document.getElementById('history-number');
            numberInput.value = ''; // Clear previous value
            numberInput.removeEventListener('input', updateHistoryPreview);
            numberInput.addEventListener('input', updateHistoryPreview);
            
            // Update preview
            updateHistoryPreview();
        }
        
        function selectHistoryPolarization(pol) {
            selectedHistoryPolarization = pol;
            
            // Highlight selected button
            document.getElementById('history-pol-1').style.backgroundColor = pol === '1' ? '#007bff' : '';
            document.getElementById('history-pol-1').style.color = pol === '1' ? 'white' : '';
            document.getElementById('history-pol-2').style.backgroundColor = pol === '2' ? '#007bff' : '';
            document.getElementById('history-pol-2').style.color = pol === '2' ? 'white' : '';
            
            // Update preview
            updateHistoryPreview();
        }
        
        function updateHistoryPreview() {
            if (!selectedHistoryAbbrev) return;
            
            const numberInput = document.getElementById('history-number').value;
            const number = numberInput ? numberInput.padStart(5, '0') : '?????';
            
            const preview = `${selectedHistoryAbbrev}${number}P${selectedHistoryPolarization}`;
            document.getElementById('history-part-preview').textContent = preview;
        }
        
        function fetchPartHistoryFromBuilder() {
            if (!selectedHistoryAbbrev) {
                document.getElementById('history-results').innerHTML = 
                    '<div class="status-error">‚ùå Please select a part type first</div>';
                return;
            }
            
            const numberInput = document.getElementById('history-number').value.trim();
            
            if (!numberInput) {
                document.getElementById('history-results').innerHTML = 
                    '<div class="status-error">‚ùå Please enter a part number</div>';
                return;
            }
            
            // Pad the number to 5 digits
            const number = numberInput.padStart(5, '0');
            
            // Build the part number using selected polarization
            const partNumber = `${selectedHistoryAbbrev}${number}P${selectedHistoryPolarization}`;
            
            // Set it in the text input field (for consistency)
            document.getElementById('history-part-input').value = partNumber;
            
            // Fetch history
            fetchPartHistoryByNumber(partNumber);
        }
        
        async function fetchPartHistoryByNumber(partNumber) {
            const resultsDiv = document.getElementById('history-results');
            resultsDiv.innerHTML = '<div class="status-info">‚è≥ Loading history...</div>';
            
            try {
                const response = await fetch('/scanner/api/part-history', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ part_number: partNumber })
                });
                
                const result = await response.json();
                
                if (result.success && result.history.length > 0) {
                    let tableHTML = `
                        <div class="status-success">
                            <h3>üìã History for ${result.part_number}</h3>
                            <p>Found ${result.history.length} record(s)</p>
                            <table style="width: 100%; margin-top: 15px; border-collapse: collapse; text-align: left;">
                                <thead>
                                    <tr style="background-color: #f0f0f0; border-bottom: 2px solid #333;">
                                        <th style="padding: 10px; border: 1px solid #ddd;">Connected Part</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">Timestamp</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    result.history.forEach(record => {
                        // Determine which part is the "other" part (not the one we're querying for)
                        const otherPart = record.part_number === partNumber ? record.connected_to : record.part_number;
                        const otherPartType = record.part_number === partNumber ? record.connected_to_type : record.part_type;
                        
                        const statusIcon = record.status === 'connected' ? 'üîó' : '‚ùå';
                        const statusText = record.status === 'connected' ? 'Connected' : 'Disconnected';
                        const rowColor = record.status === 'connected' ? '#e8f5e9' : '#ffebee';
                        
                        tableHTML += `
                            <tr style="background-color: ${rowColor};">
                                <td style="padding: 10px; border: 1px solid #ddd;"><strong>${otherPart}</strong><br><small>${otherPartType}</small></td>
                                <td style="padding: 10px; border: 1px solid #ddd;"><small>${record.timestamp}</small></td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${statusIcon} ${statusText}</td>
                            </tr>`;
                    });
                    
                    tableHTML += `
                                </tbody>
                            </table>
                        </div>`;
                    
                    resultsDiv.innerHTML = tableHTML;
                } else if (result.success && result.history.length === 0) {
                    resultsDiv.innerHTML = `<div class="status-info">‚ÑπÔ∏è No connection history found for ${partNumber}</div>`;
                } else {
                    resultsDiv.innerHTML = `<div class="status-error">‚ùå ${result.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status-error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // ============================================================================
        // REMOVE PART FUNCTIONS
        // ============================================================================
        
        // === REMOVE PART FUNCTIONS ===
        
        function selectRemoveInputMethod(method) {
            if (method === 'barcode') {
                setupRemoveBarcodeInput();
                goToStep('remove-barcode');
            } else if (method === 'manual') {
                setupRemoveManualEntry();
                goToStep('remove-manual');
            }
        }
        
        function setupRemoveBarcodeInput() {
            const input = document.getElementById('remove-barcode-input');
            const statusDiv = document.getElementById('remove-barcode-status');
            
            input.value = '';
            statusDiv.innerHTML = '<div class="status-info">Scan or type part number to remove</div>';
            
            input.onkeypress = async function(e) {
                if (e.key === 'Enter') {
                    const partNumber = input.value.trim();
                    if (partNumber) {
                        await processRemovePart(partNumber);
                    }
                }
            };
            
            setTimeout(() => input.focus(), 100);
        }
        
        function setupRemoveManualEntry() {
            // Populate part type buttons (exclude SNAP - users can only remove up to BACBOARD)
            const container = document.getElementById('remove-part-type-buttons');
            container.innerHTML = '';
            
            const partTypes = ['ANTENNA', 'LNA', 'COAXSHORT', 'COAXLONG', 'BACBOARD'];
            partTypes.forEach(type => {
                const button = document.createElement('button');
                button.textContent = type;
                button.onclick = () => selectRemovePartType(type);
                container.appendChild(button);
            });
            
            // Hide subsequent steps
            document.getElementById('remove-polarization').classList.add('hidden');
            document.getElementById('remove-number').classList.add('hidden');
            document.getElementById('remove-manual-status').innerHTML = '';
        }
        
        function selectRemovePartType(type) {
            state.removePartType = type;
            
            // Highlight selected button
            const buttons = document.getElementById('remove-part-type-buttons').querySelectorAll('button');
            buttons.forEach(btn => {
                btn.classList.toggle('button-selected', btn.textContent === type);
            });
            
            // Show polarization selection
            document.getElementById('remove-polarization').classList.remove('hidden');
            document.getElementById('remove-number').classList.add('hidden');
            state.removePolarization = null;
            
            // Clear polarization button selections
            const polButtons = document.getElementById('remove-polarization-buttons').querySelectorAll('button');
            polButtons.forEach(btn => btn.classList.remove('button-selected'));
        }
        
        function selectRemovePolarization(pol) {
            state.removePolarization = pol;
            
            // Highlight selected button
            const buttons = document.getElementById('remove-polarization-buttons').querySelectorAll('button');
            buttons.forEach(btn => {
                btn.classList.toggle('button-selected', btn.textContent.includes(pol));
            });
            
            // Show number input
            document.getElementById('remove-number').classList.remove('hidden');
            
            // Set appropriate placeholder
            const input = document.getElementById('remove-part-number-input');
            if (state.removePartType === 'ANTENNA') {
                input.placeholder = `e.g., 00001 for ANT00001P${pol}`;
            } else if (state.removePartType === 'LNA') {
                input.placeholder = `e.g., 00001 for LNA00001P${pol}`;
            } else if (state.removePartType === 'COAXSHORT') {
                input.placeholder = `e.g., 00001 for CXS00001P${pol}`;
            } else if (state.removePartType === 'COAXLONG') {
                input.placeholder = `e.g., 00001 for CXL00001P${pol}`;
            } else if (state.removePartType === 'BACBOARD') {
                input.placeholder = `e.g., 00001 for BAC00001P${pol}`;
            }
            
            setTimeout(() => input.focus(), 100);
        }
        
        async function submitRemovePart() {
            const numberInput = document.getElementById('remove-part-number-input');
            const number = numberInput.value.trim();
            
            if (!number) {
                document.getElementById('remove-manual-status').innerHTML = 
                    '<div class="status-error">‚ùå Please enter a part number</div>';
                return;
            }
            
            let partNumber;
            
            if (state.removePartType === 'ANTENNA') {
                partNumber = `ANT${number.padStart(5, '0')}P${state.removePolarization}`;
            } else if (state.removePartType === 'LNA') {
                partNumber = `LNA${number.padStart(5, '0')}P${state.removePolarization}`;
            } else if (state.removePartType === 'COAXSHORT') {
                partNumber = `CXS${number.padStart(5, '0')}P${state.removePolarization}`;
            } else if (state.removePartType === 'COAXLONG') {
                partNumber = `CXL${number.padStart(5, '0')}P${state.removePolarization}`;
            } else if (state.removePartType === 'BACBOARD') {
                partNumber = `BAC${number.padStart(5, '0')}P${state.removePolarization}`;
            }
            
            await processRemovePart(partNumber);
        }
        
        async function processRemovePart(partNumber) {
            const statusDiv = document.getElementById('remove-barcode-status') || 
                             document.getElementById('remove-manual-status');
            
            statusDiv.innerHTML = '<div class="status-info">‚è≥ Validating part...</div>';
            
            try {
                // Validate part exists
                const validateResponse = await fetch('/scanner/api/validate-part', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({part_number: partNumber})
                });
                
                const validateResult = await validateResponse.json();
                
                if (!validateResult.success) {
                    statusDiv.innerHTML = `<div class="status-error">‚ùå ${validateResult.error}</div>`;
                    return;
                }
                
                // Get connections
                const connectionsResponse = await fetch('/scanner/api/get-connections', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({part_number: partNumber})
                });
                
                const connectionsResult = await connectionsResponse.json();
                
                if (!connectionsResult.success) {
                    statusDiv.innerHTML = `<div class="status-error">‚ùå ${connectionsResult.error}</div>`;
                    return;
                }
                
                // Store part and connections for confirmation
                state.removePart = {
                    part_number: validateResult.part_number,
                    part_type: validateResult.part_type,
                    polarization: validateResult.polarization
                };
                state.removeConnections = connectionsResult.connections || [];
                
                // Show confirmation screen
                showRemoveConfirmation();
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function showRemoveConfirmation() {
            // If no connections, skip confirmation and go straight to results
            if (state.removeConnections.length === 0) {
                const resultsDiv = document.getElementById('remove-results');
                resultsDiv.innerHTML = `
                    <div class="status-info">
                        <h3>‚ÑπÔ∏è No Action Needed</h3>
                        <p><strong>${state.removePart.part_number}</strong> has no active connections.</p>
                        <p>No database changes were made.</p>
                    </div>`;
                goToStep('remove-result');
                return;
            }
            
            // Display part info
            const displayDiv = document.getElementById('remove-part-display');
            displayDiv.innerHTML = `
                <h3>Part to Remove:</h3>
                <p><strong>Part Number:</strong> ${state.removePart.part_number}</p>
                <p><strong>Type:</strong> ${state.removePart.part_type}</p>
                <p><strong>Polarization:</strong> ${state.removePart.polarization || 'N/A'}</p>
            `;
            
            // Display connections with warning
            const connectionsDiv = document.getElementById('remove-connections-display');
            let html = `
                <div class="status-info" style="background-color: #fff3cd; border-color: #ffc107;">
                    <h3>‚ö†Ô∏è Warning</h3>
                    <p><strong>${state.removeConnections.length} connection(s) will be disconnected:</strong></p>
                    <ul style="text-align: left; margin: 10px 20px;">`;
            
            state.removeConnections.forEach(conn => {
                if (conn.part_number === state.removePart.part_number) {
                    html += `<li>${conn.part_number} ‚Üí ${conn.connected_to} (${conn.connected_to_type})</li>`;
                } else {
                    // Backward connection - infer part type from part number
                    const otherPartType = getPartTypeFromNumber(conn.part_number);
                    html += `<li>${conn.part_number} (${otherPartType}) ‚Üí ${conn.connected_to}</li>`;
                }
            });
            
            html += `</ul></div>`;
            connectionsDiv.innerHTML = html;
            
            // Reset the confirm button to its initial state
            const confirmButton = document.getElementById('confirm-remove-btn');
            confirmButton.disabled = false;
            confirmButton.textContent = 'üóëÔ∏è Confirm Removal';
            
            goToStep('remove-confirm');
        }
        
        function cancelRemoval() {
            state.removePart = null;
            state.removeConnections = [];
            state.removePartType = null;
            state.removePolarization = null;
            goToStep('remove-method');
        }
        
        async function confirmRemovePart() {
            const button = document.getElementById('confirm-remove-btn');
            button.disabled = true;
            button.textContent = '‚è≥ Processing...';
            
            const resultsDiv = document.getElementById('remove-results');
            
            try {
                if (state.removeConnections.length === 0) {
                    // No connections to disconnect
                    resultsDiv.innerHTML = `
                        <div class="status-success">
                            <h3>‚úì Removal Complete</h3>
                            <p><strong>${state.removePart.part_number}</strong> had no active connections.</p>
                        </div>`;
                    goToStep('remove-result');
                    return;
                }
                
                let disconnectedCount = 0;
                let errors = [];
                
                // Disconnect each connection
                for (const conn of state.removeConnections) {
                    const response = await fetch('/scanner/api/record-disconnection', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            part_number: conn.part_number,
                            part_type: conn.part_type || getPartTypeFromNumber(conn.part_number),
                            polarization: 'X',
                            connected_to: conn.connected_to,
                            connected_to_type: conn.connected_to_type,
                            connected_polarization: 'X'
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        disconnectedCount++;
                    } else {
                        errors.push(`${conn.part_number} ‚Üî ${conn.connected_to}: ${result.error || 'Unknown error'}`);
                    }
                }
                
                // Show results
                if (errors.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="status-success">
                            <h3>‚úì Part Removed Successfully</h3>
                            <p><strong>${state.removePart.part_number}</strong> has been removed.</p>
                            <p>Disconnected ${disconnectedCount} connection(s).</p>
                        </div>`;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="status-error">
                            <h3>‚ö†Ô∏è Partial Success</h3>
                            <p>Disconnected ${disconnectedCount} of ${state.removeConnections.length} connection(s).</p>
                            <p><strong>Errors:</strong></p>
                            <ul style="text-align: left; margin: 10px 20px;">
                                ${errors.map(err => `<li>${err}</li>`).join('')}
                            </ul>
                        </div>`;
                }
                
                goToStep('remove-result');
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status-error">‚ùå Error: ${error.message}</div>`;
                goToStep('remove-result');
            }
        }
        
        function switchToRemoveManual() {
            setupRemoveManualEntry();
            goToStep('remove-manual');
        }
        
        function switchToRemoveBarcode() {
            setupRemoveBarcodeInput();
            goToStep('remove-barcode');
        }
        
        function getPartTypeFromNumber(partNumber) {
            if (partNumber.startsWith('SNAP')) return 'SNAP';
            if (partNumber.startsWith('ANT')) return 'ANTENNA';
            if (partNumber.startsWith('LNA')) return 'LNA';
            if (partNumber.startsWith('CXS')) return 'COAXSHORT';
            if (partNumber.startsWith('CXL')) return 'COAXLONG';
            if (partNumber.startsWith('BAC')) return 'BACBOARD';
            return 'UNKNOWN';
        }
        
        function cancelSnapSelection() {
            state.snapChassis = null;
            state.snapSlot = null;
            state.snapPort = null;
            
            // If we came from manual entry (no firstPart yet), go back to manual
            // Otherwise go back to method selection
            if (!state.firstPart) {
                goToStep('manual');
            } else {
                state.firstPart = null;
                goToStep('action');
            }
        }
        
        // Show connection selection for disconnect
        function showConnectionSelection() {
            const displayDiv = document.getElementById('first-part-display');
            displayDiv.innerHTML = `
                <h3>Part to Disconnect:</h3>
                <p><strong>Part Number:</strong> ${state.firstPart.part_number}</p>
                <p><strong>Type:</strong> ${state.firstPart.part_type}</p>
                <p><strong>Polarization:</strong> ${state.firstPart.polarization}</p>
            `;
            
            const listDiv = document.getElementById('connection-list-container');
            listDiv.innerHTML = '<h3>Select Connection:</h3>';
            
            state.connections.forEach((conn, idx) => {
                const div = document.createElement('div');
                div.className = 'connection-item';
                
                if (conn.part_number === state.firstPart.part_number) {
                    div.innerHTML = `
                        <strong>${conn.part_number}</strong> ‚Üí ${conn.connected_to} (${conn.connected_to_type})
                        <br><small>Scanned: ${conn.scan_time}</small>
                    `;
                    div.onclick = () => selectConnection(conn.connected_to, conn.connected_to_type);
                } else {
                    div.innerHTML = `
                        ${conn.part_number} ‚Üí <strong>${conn.connected_to}</strong> (${conn.connected_to_type})
                        <br><small>Scanned: ${conn.scan_time}</small>
                    `;
                    div.onclick = () => selectConnection(conn.part_number, conn.connected_to_type);
                }
                
                listDiv.appendChild(div);
            });
            
            goToStep('select-connection');
        }
        
        async function selectConnection(otherPartNumber, otherPartType) {
            // Get the other part's details
            try {
                const response = await fetch('/scanner/api/validate-part', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({part_number: otherPartNumber})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    state.secondPart = {
                        part_number: result.part_number,
                        part_type: result.part_type,
                        polarization: result.polarization,
                        existing_connections: result.existing_connections || []
                    };
                    
                    showConfirmation();
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        function cancelDisconnection() {
            state.firstPart = null;
            state.connections = [];
            resetScanner();
        }
        
        // Show confirmation
        function showConfirmation() {
            const detailsDiv = document.getElementById('confirm-details');
            
            if (state.action === 'connect') {
                detailsDiv.innerHTML = `
                    <h3>Confirm Connection:</h3>
                    <div style="margin: 15px 0;">
                        <h4>First Part (Source):</h4>
                        <p><strong>Part:</strong> ${state.firstPart.part_number}</p>
                        <p><strong>Type:</strong> ${state.firstPart.part_type}</p>
                        <p><strong>Polarization:</strong> ${state.firstPart.polarization}</p>
                    </div>
                    <div style="text-align: center; font-size: 24px; margin: 10px 0;">‚Üì</div>
                    <div style="margin: 15px 0;">
                        <h4>Second Part (Target):</h4>
                        <p><strong>Part:</strong> ${state.secondPart.part_number}</p>
                        <p><strong>Type:</strong> ${state.secondPart.part_type}</p>
                        <p><strong>Polarization:</strong> ${state.secondPart.polarization}</p>
                    </div>
                `;
            } else {
                detailsDiv.innerHTML = `
                    <h3>Confirm Disconnection:</h3>
                    <div style="margin: 15px 0;">
                        <h4>First Part:</h4>
                        <p><strong>Part:</strong> ${state.firstPart.part_number}</p>
                        <p><strong>Type:</strong> ${state.firstPart.part_type}</p>
                    </div>
                    <div style="text-align: center; font-size: 24px; margin: 10px 0;">‚úó</div>
                    <div style="margin: 15px 0;">
                        <h4>Second Part:</h4>
                        <p><strong>Part:</strong> ${state.secondPart.part_number}</p>
                        <p><strong>Type:</strong> ${state.secondPart.part_type}</p>
                    </div>
                `;
            }
            
            goToStep('confirm');
        }
        
        function cancelOperation() {
            state.secondPart = null;
            resetScanner();
        }
        
        // Confirm and execute operation
        async function confirmOperation() {
            const resultDiv = document.getElementById('result-message');
            resultDiv.innerHTML = '<div class="status-info status-message">‚è≥ Processing...</div>';
            
            // Set the continue button text
            const continueText = state.action === 'connect' ? 'Connecting' : 'Disconnecting';
            document.getElementById('continue-action-text').textContent = continueText;
            
            goToStep('result');
            
            try {
                const endpoint = state.action === 'connect' ? '/scanner/api/record-connection' : '/scanner/api/record-disconnection';
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        part_number: state.firstPart.part_number,
                        part_type: state.firstPart.part_type,
                        polarization: state.firstPart.polarization,
                        connected_to: state.secondPart.part_number,
                        connected_to_type: state.secondPart.part_type,
                        connected_polarization: state.secondPart.polarization
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<div class="status-success status-message">‚úì ${result.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status-error status-message">‚ùå ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status-error status-message">‚ùå Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
